<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>监控面板 - Ticketradar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light rounded mt-3 mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">
                    <i class="bi bi-airplane text-primary"></i> Ticketradar
                </a>

                <div class="navbar-nav ms-auto">
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> admin
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/"><i class="bi bi-house"></i> 首页</a></li>
                            
                            <li><a class="dropdown-item" href="/admin"><i class="bi bi-gear"></i> 管理面板</a></li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-right"></i> 退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-speedometer2 text-primary"></i> 监控面板</h2>
            
        </div>

        <!-- 消息提示 -->
        
            
        

        <!-- 监控任务显示 -->
        
            <!-- 任务详情卡片 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-play-circle"></i>
                                    深圳到所有目的地监控
                                </h5>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-light text-success">
                                        运行中
                                    </span>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-light" data-task-id="1" onclick="editTask(this.dataset.taskId)">
                                            <i class="bi bi-pencil"></i> 编辑
                                        </button>
                                        <button class="btn btn-sm btn-outline-light" data-task-id="1" onclick="toggleTask(this.dataset.taskId)">
                                            <i class="bi bi-pause"></i>
                                            暂停
                                        </button>
                                        <button class="btn btn-sm btn-outline-light" data-task-id="1" onclick="deleteTask(this.dataset.taskId)">
                                            <i class="bi bi-trash"></i> 删除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-geo-alt text-primary me-2"></i>
                                        <div>
                                            <small class="text-muted">路线</small>
                                            <div><strong>SZX</strong> → <strong>TYO</strong></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-calendar text-info me-2"></i>
                                        <div>
                                            <small class="text-muted">出行日期</small>
                                            <div>2025-06-02
                                             → 2025-06-08</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-currency-yen text-warning me-2"></i>
                                        <div>
                                            <small class="text-muted">价格阈值</small>
                                            <div><strong>¥3000.0</strong></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-clock text-muted me-2"></i>
                                        <div>
                                            <small class="text-muted">创建时间</small>
                                            <div>06-01 13:40</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统计信息 -->
            

            <!-- 航班列表 -->
            
            <div class="text-center py-5">
                <i class="bi bi-search display-1 text-muted"></i>
                <h4 class="mt-3 text-muted">暂时没有航班数据</h4>
                <p class="text-muted">请稍等，我们正在为您搜索符合条件的航班信息。<br>
这可能需要几分钟时间。</p>
            </div>
            

        
    </div>

    <!-- 创建任务模态框 -->
    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content task-modal">
                <div class="modal-header task-modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle-fill me-2"></i>创建监控任务
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/create-task">
                    <div class="modal-body task-modal-body">
                        <!-- 基本信息区域 -->
                        <div class="task-section">
                            <div class="section-header">
                                <i class="bi bi-info-circle-fill"></i>
                                <span>基本信息</span>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control task-input" id="task_name" name="task_name"
                                               placeholder="我的监控任务" required>
                                        <label for="task_name">
                                            <i class="bi bi-tag me-1"></i>任务名称
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="number" class="form-control task-input" id="price_threshold" name="price_threshold"
                                               value="1000" min="100" step="50" placeholder="1000" required>
                                        <label for="price_threshold">
                                            <i class="bi bi-currency-yen me-1"></i>价格阈值 (元)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 城市信息区域 -->
                        <div class="task-section">
                            <div class="section-header">
                                <i class="bi bi-geo-alt-fill"></i>
                                <span>城市信息</span>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control task-input" id="departure_city" name="departure_city"
                                               placeholder="BJS" pattern="[A-Z]{3}" title="请输入3位大写字母的城市代码" required>
                                        <label for="departure_city">
                                            <i class="bi bi-airplane-engines me-1"></i>出发城市代码
                                        </label>
                                    </div>
                                    <div class="city-hint">
                                        <i class="bi bi-lightbulb text-warning me-1"></i>
                                        <span>支持全球所有IATA城市代码</span>
                                        <div class="city-examples">
                                            BJS(北京) • SHA(上海) • LAX(洛杉矶) • LHR(伦敦)
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control task-input" id="destination_city" name="destination_city"
                                               placeholder="留空监控所有目的地" pattern="[A-Z]{3}" title="请输入3位大写字母的城市代码">
                                        <label for="destination_city">
                                            <i class="bi bi-geo-alt me-1"></i>目的地代码 (可选)
                                        </label>
                                    </div>
                                    <div class="city-hint">
                                        <i class="bi bi-info-circle text-info me-1"></i>
                                        <span>留空监控所有目的地</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 日期信息区域 -->
                        <div class="task-section">
                            <div class="section-header">
                                <i class="bi bi-calendar-event-fill"></i>
                                <span>出行日期</span>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="date" class="form-control task-input" id="depart_date" name="depart_date" required>
                                        <label for="depart_date">
                                            <i class="bi bi-airplane-fill me-1" style="transform: rotate(-45deg);"></i>出发日期
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="date" class="form-control task-input" id="return_date" name="return_date">
                                        <label for="return_date">
                                            <i class="bi bi-airplane-fill me-1" style="transform: rotate(135deg);"></i>返回日期 (可选)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 通知设置区域 -->
                        <div class="task-section">
                            <div class="section-header">
                                <i class="bi bi-bell-fill"></i>
                                <span>通知设置</span>
                            </div>
                            <div class="notification-card">
                                <div class="form-floating">
                                    <input type="text" class="form-control task-input" id="pushplus_token" name="pushplus_token"
                                           placeholder="输入您的PushPlus令牌">
                                    <label for="pushplus_token">
                                        <i class="bi bi-key me-1"></i>PushPlus通知令牌 (可选)
                                    </label>
                                </div>
                                <div class="notification-info">
                                    <div class="info-item">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        <span>免费接收低价机票通知</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="bi bi-shield-check text-primary me-2"></i>
                                        <span>安全可靠，无需实名认证</span>
                                    </div>
                                    <a href="http://www.pushplus.plus/" target="_blank" class="get-token-link">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>获取令牌
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer task-modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>取消
                        </button>
                        <button type="submit" class="btn btn-primary btn-create-task">
                            <i class="bi bi-rocket-takeoff me-1"></i>创建任务
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 编辑任务模态框 -->
    <div class="modal fade" id="editTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil text-primary"></i> 编辑监控任务
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editTaskForm" method="POST">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_task_name" class="form-label">任务名称</label>
                                    <input type="text" class="form-control" id="edit_task_name" name="task_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_price_threshold" class="form-label">价格阈值 (元)</label>
                                    <input type="number" class="form-control" id="edit_price_threshold" name="price_threshold"
                                           min="100" step="50" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_departure_city" class="form-label">出发城市代码</label>
                                    <input type="text" class="form-control" id="edit_departure_city" name="departure_city"
                                           placeholder="如：BJS(北京), SHA(上海), CAN(广州), SZX(深圳)"
                                           pattern="[A-Z]{3}" title="请输入3位大写字母的城市代码" required>
                                    <div class="form-text">
                                        支持任何3位字母的IATA城市代码，如：BJS(北京), SHA(上海), CAN(广州), SZX(深圳), HKG(香港), CTU(成都), WUH(武汉), XIY(西安), LAX(洛杉矶), JFK(纽约), LHR(伦敦)等
                                        <br><small class="text-success">✅ 现在支持全球所有城市代码！</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_destination_city" class="form-label">目的地城市代码 (可选)</label>
                                    <input type="text" class="form-control" id="edit_destination_city" name="destination_city"
                                           placeholder="如：NRT(东京), ICN(首尔) 或留空监控所有目的地"
                                           pattern="[A-Z]{3}" title="请输入3位大写字母的城市代码">
                                    <div class="form-text">留空将监控所有目的地，或输入特定目的地代码</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_depart_date" class="form-label">出发日期</label>
                                    <input type="date" class="form-control" id="edit_depart_date" name="depart_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_return_date" class="form-label">返回日期 (可选)</label>
                                    <input type="date" class="form-control" id="edit_return_date" name="return_date">
                                </div>
                            </div>
                        </div>

                        <!-- PushPlus通知配置 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="edit_pushplus_token" class="form-label">
                                        <i class="bi bi-bell text-info me-2"></i>PushPlus通知令牌 (可选)
                                    </label>
                                    <input type="text" class="form-control" id="edit_pushplus_token" name="pushplus_token"
                                           placeholder="输入您的PushPlus令牌以接收价格通知">
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>
                                        可选：填入您的PushPlus令牌以接收低价通知。
                                        <a href="http://www.pushplus.plus/" target="_blank" class="text-decoration-none">
                                            <i class="bi bi-box-arrow-up-right me-1"></i>获取令牌
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> 更新任务
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 设置默认日期
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const departDateInput = document.getElementById('depart_date');
            if (departDateInput) {
                departDateInput.value = tomorrow.toISOString().split('T')[0];
            }
        });

        function editTask(taskId) {
            // 获取任务详情
            fetch(`/edit-task/${taskId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                // 填充表单数据
                document.getElementById('edit_task_name').value = data.name;
                document.getElementById('edit_price_threshold').value = data.price_threshold;
                document.getElementById('edit_departure_city').value = data.departure_city;
                document.getElementById('edit_destination_city').value = data.destination_city || '';
                document.getElementById('edit_depart_date').value = data.depart_date;
                document.getElementById('edit_return_date').value = data.return_date || '';
                document.getElementById('edit_pushplus_token').value = data.pushplus_token || '';

                // 设置表单提交地址
                document.getElementById('editTaskForm').action = `/edit-task/${taskId}`;

                // 显示模态框
                new bootstrap.Modal(document.getElementById('editTaskModal')).show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取任务信息失败');
            });
        }

        function toggleTask(taskId) {
            if (confirm('确定要切换任务状态吗？')) {
                fetch(`/toggle-task/${taskId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || '操作失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败');
                });
            }
        }

        function deleteTask(taskId) {
            if (confirm('确定要删除这个监控任务吗？此操作不可撤销。')) {
                fetch(`/delete-task/${taskId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || '删除失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败');
                });
            }
        }

        // 移除showSupportedCities函数，因为现在支持所有城市代码
    </script>
</body>
</html>